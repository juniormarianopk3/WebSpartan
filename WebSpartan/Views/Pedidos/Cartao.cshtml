@model WebSpartan.Models.Pedido
@{
    ViewData["Title"] = "Pagamento Cartão - Pedido #" + Model.Id;

    var totalFinal = (Model.Subtotal - Model.Desconto) + Model.Frete;
    var cashbackGerado = Model.CashbackGerado;

}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-7">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h3 class="fw-bold mb-2">💳 Pedido #@Model.Id</h3>

                    <p class="text-muted mb-1"><b>Status:</b> <span id="statusPedido">@Model.Status</span></p>
                    <p class="text-muted mb-3"><b>Total:</b> @totalFinal.ToString("C")</p>

                    <hr />

                    <h5 class="fw-semibold mb-3">Itens do pedido</h5>

                    <ul class="list-group mb-4">
                        @foreach (var item in Model.Itens)
                        {

                            var img = string.IsNullOrWhiteSpace(item.Produto?.ImagemUrl)
                            ? Url.Content("~/imagens/no-image.png")
                            : Url.Content(item.Produto.ImagemUrl);

                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-3">
                                    <img src="@img"
                                         alt="@item.Produto?.Nome"
                                         class="rounded"
                                         style="width:55px;height:55px;object-fit:cover;" />

                                    <div>
                                        <strong>@item.Produto?.Nome</strong><br />
                                        <small class="text-muted">
                                            Qtd: @item.Quantidade &middot;
                                            Unid: @item.ValorUnitario.ToString("C")
                                        </small>
                                    </div>
                                </div>


                            </li>


                        }

                        <li class="list-group-item d-flex justify-content-between">
                            <span><b>Subtotal</b></span>
                            <span>@Model.Subtotal.ToString("C")</span>
                        </li>



                        <li class="list-group-item d-flex justify-content-between">
                            <span><b>Frete</b></span>
                            <span>@Model.Frete.ToString("C")</span>
                        </li>
                        @if (Model.Desconto > 0)
                        {
                            <li class="list-group-item d-flex justify-content-between text-success">
                                <span><b>Desconto</b></span>
                                <span>- @Model.Desconto.ToString("C")</span>
                            </li>
                        }
                        <li class="list-group-item d-flex justify-content-between fw-bold">
                            <span>Total</span>
                            <span>@totalFinal.ToString("C")</span>
                        </li>
                        @if (cashbackGerado > 0)
                        {
                            <li class="list-group-item d-flex justify-content-between text-success ">
                                <span><b>Cashback que você vai ganhar</b></span>
                                <span>+ @cashbackGerado.ToString("C")</span>
                            </li>
                            <li class="list-group-item -dflex">
                                <small class="text-muted small">
                                    Esse valor entra no seu saldo <b>somente após a aprovação do pagamento</b>. (Frete não gera cashback)
                                </small>
                            </li>
                        }
                        @if (Model.EntregaCombinada)
                        {
                            <li class="list-group-item">
                                <div class="alert alert-warning">
                                    <b>Entrega:</b> a combinar com o vendedor, entre em contato via WhatsApp.
                                </div>
                            </li>
                        }

                    </ul> @* ✅ FECHA O UL AQUI *@

                    @Html.AntiForgeryToken()
                    <input type="hidden" id="paymentMethodId" />
                    <input type="hidden" id="issuerId" />
                    <div class="mb-3">
                        <h5 class="fw-semibold mb-2">Dados do cartão</h5>

                        <div class="row g-2">
                            <div class="col-12">
                                <input id="cardNumber" class="form-control" placeholder="Número do cartão" />
                            </div>
                            <div class="col-6">
                                <input id="cardExpMonth" class="form-control" placeholder="MM" />
                            </div>
                            <div class="col-6">
                                <input id="cardExpYear" class="form-control" placeholder="AA" />
                            </div>
                            <div class="col-6">
                                <input id="securityCode" class="form-control" placeholder="CVV" />
                            </div>
                            <div class="col-6">
                                <input id="cardholderName" class="form-control" placeholder="Nome no cartão" />
                            </div>

                            <div class="col-6">
                                <select id="identificationType" class="form-select">
                                    <option value="CPF">CPF</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <input id="identificationNumber" class="form-control" placeholder="CPF (somente números)" />
                            </div>

                            <div class="col-12">
                                <input id="email" class="form-control" placeholder="E-mail" value="@Model.User?.Email" />
                            </div>

                            <div class="col-12">
                                <select id="installments" class="form-select">
                                    <option value="">Digite o cartão para ver as parcelas</option>
                                </select>
                                <div class="mt-2 small text-muted" id="installmentsInfo"></div>
                            </div>
                        </div>

                        <button id="btnPagarCartao" type="button" class="btn btn-primary rounded-pill px-4 mt-3">
                            <i class="bi bi-lock-fill me-1"></i> Pagar com Cartão
                        </button>

                        <div id="statusAlert" class="mt-3"></div>
                    </div>

                    <a asp-controller="Pedidos" asp-action="Historico" class="btn btn-outline-dark btn-sm">
                        <i class="bi bi-arrow-left"></i> Voltar para histórico
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://sdk.mercadopago.com/js/v2"></script>

    <script>

        let paymentId = null;
        let pollTimer = null;

        function showStatusAlert(type, title, message) {
            const el = document.getElementById('statusAlert');
            el.className = `alert alert-${type}`;
            el.innerHTML = `<b>${title}</b><br/>${message}`;
        }

        // ✅ total do pedido (sempre com . e não com , no JS)
        const totalFinal = @(((Model.Subtotal - Model.Desconto) + Model.Frete).ToString(System.Globalization.CultureInfo.InvariantCulture));

        // ✅ MercadoPago
        const mp = new MercadoPago('APP_USR-1a920d3a-a914-4a7b-bb4f-f72982b94fe5', { locale: 'pt-BR' });

        const pedidoId = @Model.Id;
        const storageKey = `mp_payment_${pedidoId}`;

        function savePaymentId(id) {
            paymentId = id;
            localStorage.setItem(storageKey, String(id));
        }

        function loadPaymentId() {
            const v = localStorage.getItem(storageKey);
            if (v) paymentId = v;
            return paymentId;
        }

        function moneyBR(v) {
            return Number(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function startPolling() {
            if (!paymentId) return;
            if (pollTimer) clearInterval(pollTimer);

            pollTimer = setInterval(() => {
                fetch('/Payment/CheckPayment?paymentId=' + paymentId)
                    .then(r => r.json())
                    .then(data => {
                        const status = (data.status || '').toLowerCase();
                        if (status === 'approved') {
                            clearInterval(pollTimer);
                            showStatusAlert('success', 'Pagamento aprovado ✅', 'Pedido confirmado! Redirecionando...');
                            document.getElementById('statusPedido').textContent = 'Pago';

                            setTimeout(() => {
                                window.location.href = data.redirectUrl || ('/Pedidos/PagamentoAprovado/' + pedidoId);
                            }, 1200);
                        }
                    })
                    .catch(() => { });
            }, 8000);
        }

        // ✅ Se já tinha paymentId salvo, volta a checar automaticamente
        if (loadPaymentId()) startPolling();

        // -----------------------------
        // ✅ Parcelas com valor/juros
        // -----------------------------
        const cardNumberEl = document.getElementById('cardNumber');
        const installmentsEl = document.getElementById('installments');
        const installmentsInfoEl = document.getElementById('installmentsInfo');

        let currentPaymentMethodId = null;

        function resetParcelasUI(msg = 'Digite o cartão para ver as parcelas') {
            currentPaymentMethodId = null;
            installmentsEl.innerHTML = `<option value="">${msg}</option>`;
            if (installmentsInfoEl) installmentsInfoEl.textContent = '';
        }

        async function detectarBandeiraPorBin(bin) {
            const res = await mp.getPaymentMethods({ bin });
            const pm = res?.results?.[0];
            return pm?.id || null;
        }

        async function carregarParcelas() {
            const digits = (cardNumberEl.value || '').replace(/\D/g, '');

            // ✅ se não tiver BIN, reseta UI e sai
            if (digits.length < 6) {
                resetParcelasUI();
                return;
            }

            const bin = digits.substring(0, 6);

            try {
                currentPaymentMethodId = await detectarBandeiraPorBin(bin);

                if (totalFinal < 5) { // ajuste conforme regra do gateway
                    installmentsEl.innerHTML = '<option value="1">1x (sem parcelamento)</option>';
                    if (installmentsInfoEl) {
                        installmentsInfoEl.textContent = 'Valor muito baixo para parcelamento.';
                    }
                    return; // encerra aqui sem chamar a API
                }

                if (!currentPaymentMethodId) {
                    resetParcelasUI('Bandeira não identificada');
                    return;
                }

                const amount = totalFinal.toFixed(2); // "2.00"

                const inst = await mp.getInstallments({
                    amount: amount,
                    bin,
                    paymentMethodId: currentPaymentMethodId
                });
                if (Array.isArray(inst) && inst[0]?.message) {
                    console.warn('Erro da API de parcelas:', inst);
                    resetParcelasUI('Não foi possível carregar parcelas (valor muito baixo ou inválido).');
                    return;
                }

                const payerCosts = inst?.[0]?.payer_costs || [];

                installmentsEl.innerHTML = '';

                if (!payerCosts.length) {
                    installmentsEl.innerHTML = `<option value="1">1x (sem info de parcelas)</option>`;
                    if (installmentsInfoEl) installmentsInfoEl.textContent = 'Não foi possível carregar parcelas.';
                    return;
                }

                payerCosts.forEach(pc => {
                    const n = pc.installments;
                    const parcela = pc.installment_amount;
                    const total = pc.total_amount;
                    const juros = pc.installment_rate || 0;

                    const label = juros > 0
                        ? `${n}x de ${moneyBR(parcela)} (total ${moneyBR(total)}) com juros`
                        : `${n}x de ${moneyBR(parcela)} (total ${moneyBR(total)}) sem juros`;

                    const opt = document.createElement('option');
                    opt.value = String(n);
                    opt.textContent = label;
                    installmentsEl.appendChild(opt);
                });

                // ✅ seleciona a primeira opção automaticamente
                installmentsEl.value = installmentsEl.options[0].value;

                if (installmentsInfoEl) installmentsInfoEl.textContent = 'Selecione o parcelamento acima.';
            } catch (e) {
                console.error('Erro ao carregar parcelas:', e);
                resetParcelasUI('Erro ao carregar parcelas');
            }
        }
        // debounce simples
        let t = null;
        cardNumberEl.addEventListener('input', () => {
            clearTimeout(t);
            t = setTimeout(carregarParcelas, 400);
        });

        cardNumberEl.addEventListener('blur', carregarParcelas);


        // ===========================
        // Máscaras de input
        // ===========================

        // Máscara do número do cartão (com espaçamento a cada 4 dígitos)
        cardNumberEl.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            value = value.substring(0, 16);

            // Adiciona espaço a cada 4 dígitos
            let formatted = value.match(/.{1,4}/g)?.join(' ') || value;

            e.target.value = formatted;
        });

        // Máscara do mês (MM)
        document.getElementById('cardExpMonth').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            value = value.substring(0, 2);

            // Ajusta automaticamente valores inválidos
            if (value.length === 2) {
                const month = parseInt(value);
                if (month > 12) value = '12';
                if (month === 0) value = '01';
            }

            e.target.value = value;
        });

        // Máscara do ano (AA)
        document.getElementById('cardExpYear').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            value = value.substring(0, 2);
            e.target.value = value;
        });

        // Máscara do CVV (3-4 dígitos)
        document.getElementById('securityCode').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            value = value.substring(0, 4);
            e.target.value = value;
        });

        // Máscara do CPF (000.000.000-00)
        document.getElementById('identificationNumber').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            value = value.substring(0, 11);

            if (value.length <= 3) {
                e.target.value = value;
            } else if (value.length <= 6) {
                e.target.value = value.replace(/(\d{3})(\d+)/, '$1.$2');
            } else if (value.length <= 9) {
                e.target.value = value.replace(/(\d{3})(\d{3})(\d+)/, '$1.$2.$3');
            } else {
                e.target.value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
            }
        });

        // Máscara do nome (converte para maiúsculas)
        document.getElementById('cardholderName').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });
        // -----------------------------
        // ✅ Tokenização MP (TOKEN REAL)
        // -----------------------------
        async function gerarTokenCartao() {
            const number = (document.getElementById('cardNumber').value || '').replace(/\D/g, '');
            const expMonth = (document.getElementById('cardExpMonth').value || '').trim();
            const expYear = (document.getElementById('cardExpYear').value || '').trim();
            const cvv = (document.getElementById('securityCode').value || '').trim();
            const name = (document.getElementById('cardholderName').value || '').trim();
            const idType = document.getElementById('identificationType').value;
            const idNumber = (document.getElementById('identificationNumber').value || '').replace(/\D/g, '');

            const expYearFull = (expYear.length === 2) ? ('20' + expYear) : expYear;

            const tokenResponse = await mp.createCardToken({
                cardNumber: number,
                cardholderName: name,
                cardExpirationMonth: expMonth,
                cardExpirationYear: expYearFull,
                securityCode: cvv,
                identificationType: idType,
                identificationNumber: idNumber
            });

            // ✅ valida de forma segura
            if (!tokenResponse || !tokenResponse.id) {
                console.error('Token response:', tokenResponse);
                throw new Error('Não foi possível gerar o token do cartão. Verifique os dados.');
            }

            return tokenResponse.id;
        }

        // -----------------------------
        // ✅ Clique pagar
        // -----------------------------
        document.getElementById('btnPagarCartao').addEventListener('click', async () => {
            try {
                showStatusAlert('info', 'Processando...', 'Gerando token e enviando pagamento.');

                // garante parcelas carregadas / bandeira detectada
                const digits = (cardNumberEl.value || '').replace(/\D/g, '');
                if (digits.length < 6) {
                    showStatusAlert('warning', 'Cartão inválido', 'Digite o número do cartão corretamente.');
                    return;
                }
                if (!currentPaymentMethodId) {
                    await carregarParcelas(); // tenta descobrir e carregar
                }
                if (!currentPaymentMethodId) {
                    showStatusAlert('warning', 'Bandeira não identificada', 'Verifique o número do cartão.');
                    return;
                }

                const anti = document.querySelector('input[name="__RequestVerificationToken"]').value;

                // ✅ gera token REAL
                const token = await gerarTokenCartao();

                const installments = parseInt(installmentsEl.value || '1');

                const payload = {
                    pedidoId: pedidoId,
                    token: token,
                    paymentMethodId: currentPaymentMethodId, // ✅ agora é real
                    installments: installments,
                    payerEmail: document.getElementById('email').value,
                    identificationType: document.getElementById('identificationType').value,
                    identificationNumber: document.getElementById('identificationNumber').value
                };

                fetch('/Payment/CreateCardPayment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': anti
                    },
                    body: JSON.stringify(payload)
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.error) {
                            showStatusAlert('danger', 'Erro', data.message || 'Falha ao criar pagamento.');
                            return;
                        }

                        savePaymentId(data.paymentId);

                        const status = (data.status || '').toLowerCase();
                        if (status === 'approved') {
                            showStatusAlert('success', 'Aprovado ✅', 'Pagamento aprovado! Redirecionando...');
                            setTimeout(() => window.location.href = '/Pedidos/PagamentoAprovado/' + pedidoId, 6000);
                        } else {
                            showStatusAlert('warning', 'Pagamento criado', `Status: ${status}. Vou verificar automaticamente.`);
                            startPolling();
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        showStatusAlert('danger', 'Erro', 'Falha na comunicação com o servidor.');
                    });

            } catch (e) {
                console.error(e);
                showStatusAlert('danger', 'Erro no cartão', e.message || 'Verifique os dados do cartão.');
            }
        });
    </script>
}

